#= require jquery-2.1.4.min
map = undefined
markers = []
screen = 'start'

$ ->
  # console.log 'maps works'
  $('.newroute').click ->
    goStart()

  $('.goabout').click (e) ->
    e.preventDefault()
    goScreen('about')


# window.intToTime = (value) ->
#   h = Math.floor(value/60/60)
#   o = value % (60*60)
#   m = Math.round(o / 60)
#   return {h:h, m:m}

goScreen = (new_screen) ->
  $('.screen_'+screen).fadeOut 500
  $('.screen_'+new_screen).fadeIn 500
  $('body').removeClass(screen).addClass(new_screen)
  screen = new_screen

caluclateTime = (route) ->
  format = (s) ->
    s = '0' + s if s < 10
    return s

  route = route % (24*60*60) # отсекаем дни в пути
  today = new Date
  tdy = today.getFullYear()
  tdm = today.getMonth() + 1
  tdd = today.getDate()
  parom_date = new Date(tdm + '/' + tdd + '/' + tdy)
  parom_date.setHours(17)
  # console.log 'parom_date', parom_date, parom_date - route
  time_to_start = new Date(parom_date - route*1000)
  time_to_start_string = format(time_to_start.getHours()) + ':' + format(time_to_start.getMinutes())
  if today.getHours() >= time_to_start.getHours() 
    day_to_depart = 'завтра'
  else
    day_to_depart = 'сегодня'
  $('.route-start').html 'Выезжать ' + day_to_depart + ' <br>в <span>' + time_to_start_string + '</span>'


window.initMap = ->
  directionsService = new (google.maps.DirectionsService)
  directionsDisplay = new (google.maps.DirectionsRenderer)({polylineOptions: {strokeColor: "#949fa1"}, suppressMarkers: true})
  directionsDisplay.suppressMarkers = true
  map = new (google.maps.Map)(document.getElementById('map'),
    zoom: 7
    disableDefaultUI: true
    scrollwheel: false
    center:
      lat: 60.2312266
      lng: 28.0543429)
  map.setOptions({styles: styles})
  directionsDisplay.setMap map




  onChangeHandler = ->
    calculateAndDisplayRoute directionsService, directionsDisplay
    return

  $('.calculate-button').click (e) ->
    e.preventDefault() 
    onChangeHandler() if $('.map-input').val().length > 0

  $('.map-input').keyup (e) ->
    # console.log e
    if e.keyCode == 13
      onChangeHandler() if $('.map-input').val().length > 0

goFinish = () ->
  goScreen('finish')

goStart = () ->
  goScreen('start')

drawPolyline = (lat,lng) ->
  clearMarkers = ->
    i = 0
    while i < markers.length
      markers[i].setMap null
      i++
  clearMarkers()
  shapes = []
  path = []
  i = 0
  while i < path_arr.length
    obj = new google.maps.LatLng(path_arr[i][0], path_arr[i][1])
    path.push obj
    i++
  lineSymbol = {path: 'M 0,-1 0,1',strokeOpacity: 1,scale: 2}
  polyline = new (google.maps.Polyline)(
    path: path
    strokeColor: '#FFFFFF'
    strokeOpacity: 0
    # strokeWeight: 2
    icons: [{
      icon: lineSymbol,
      offset: '0',
      repeat: '10px'
    }]
  )
  polyline.setMap map
  shapes.push polyline
  # console.log lat,lng

  setTimeout (->

    # $('.screens-wrapper').hide()
    locations = [[lat, lng, 'A'],[60.16346146281146,24.969778060913086, 'B'], [59.35017084799535, 18.109073638916016, 'C']]
    bounds = new (google.maps.LatLngBounds)
    i = 0
    while i < locations.length
      marker = new (google.maps.Marker)(
        position: new (google.maps.LatLng)(locations[i][0], locations[i][1])
        map: map
        icon: "http://maps.google.com/mapfiles/marker" + locations[i][2] + ".png")
      markers.push marker
      bounds.extend marker.position
      # console.log i, marker
      i++
    map.fitBounds bounds

  ), 1500
  

calculateAndDisplayRoute = (directionsService, directionsDisplay) ->
  # waypts = []
  # waypts.push({location: {lat: 59.4391392, lng: 21.8744661}, stopover: false})
  # # waypts.push({location: {lat: 59.9248334, lng: 24.8792533}, stopover: true})
  # directionsService.route {
  #   # origin: $('#input').val()
  #   origin: 'Хельсинки, Olympiaranta 1'
  #   # destination: 'Хельсинки, Olympiaranta 1'
  #   # destination: {lat: 59.4391392, lng: 21.8744661}
  #   destination: 'Сткогольм'
  #   waypoints: waypts
  #   # travelMode: google.maps.TravelMode.TRANSIT
  #   travelMode: google.maps.TravelMode.DRIVING
  # }, (response, status) ->
  #   if status == google.maps.DirectionsStatus.OK
  #     directionsDisplay.setDirections response
  #   else
  #     window.alert 'Directions request failed due to ' + status


  directionsService.route {
    origin: $('.map-input').val()
    destination: 'Хельсинки, Olympiaranta 1'
    travelMode: google.maps.TravelMode.DRIVING
  }, (response, status) ->
    if status == google.maps.DirectionsStatus.OK
      directionsDisplay.setDirections response
      caluclateTime(response.routes[0].legs[0].duration.value)
      # console.log response.routes[0].legs[0].start_location.lat()
      $('.route-car').html(response.routes[0].legs[0].duration.text)
      goFinish()
      drawPolyline(response.routes[0].legs[0].start_location.lat(), response.routes[0].legs[0].start_location.lng())
    else
      window.alert 'Маршрут не найден, попробуйте еще раз'


  # https://developers.google.com/maps/documentation/javascript/examples/polyline-simple
styles = [
  {
    "featureType": "water",
    "elementType": "geometry",
    "stylers": [
      { "color": "#115698" }
    ]
  },{
    "featureType": "landscape",
    "elementType": "geometry",
    "stylers": [
      { "color": "#1464b0" }
    ]
  },{
    "featureType": "poi",
    "elementType": "geometry",
    "stylers": [
      { "color": "#3379bb" },
      { "weight": 0.1 },
      { "visibility": "off" }
    ]
  },{
    "elementType": "labels.text.stroke",
    "stylers": [
      { "visibility": "on" },
      { "weight": 3.1 },
      { "color": "#1567b5" }
    ]
  },{
    "featureType": "road.highway",
    "elementType": "geometry",
    "stylers": [
      { "color": "#0b3660" }
    ]
  },{
    "featureType": "road.arterial",
    "elementType": "geometry",
    "stylers": [
      { "color": "#115596" }
    ]
  },{
    "elementType": "labels.text.fill",
    "stylers": [
      { "visibility": "on" }
    ]
  },{
    "featureType": "administrative.country",
    "elementType": "geometry",
    "stylers": [
      { "visibility": "on" },
      { "color": "#0c3a67" }
    ]
  },{
    "featureType": "administrative.province",
    "elementType": "geometry.stroke",
    "stylers": [
      { "visibility": "on" },
      { "color": "#0c3a67" },
      { "weight": 0.5 }
    ]
  },{
    "featureType": "administrative.locality",
    "elementType": "labels.icon"  },{
    "featureType": "water",
    "elementType": "labels",
    "stylers": [
      { "visibility": "off" }
    ]
  }
]

path_arr = [[60.16346146281146,24.969778060913086],[60.16192411502422,24.973554611206055],[60.15765332714606,24.990034103393555],[60.15637198256438,24.99415397644043],[60.154321727338896,24.998273849487305],[60.149110086411994,25.001020431518555],[60.14774296186144,25.000333786010742],[60.14637578046982,24.999475479125977],[60.14466672379506,24.997587203979492],[60.14295757830055,24.9953556060791],[60.140821021524935,24.993295669555664],[60.139795424974196,24.992265701293945],[60.136547491592395,24.992265701293945],[60.134410518423394,24.99192237854004],[60.12765677081111,24.987287521362305],[60.12569022931492,24.985227584838867],[60.11893469177254,24.973983764648438],[60.11003921173349,24.943771362304688],[60.101825866222,24.914932250976562],[60.0682667779627,24.853134155273438],[60.05318831743673,24.821548461914062],[60.03192969911559,24.784469604492188],[60.02575527857523,24.725418090820312],[60.010657392582715,24.654006958007812],[59.99280554434853,24.619674682617188],[59.970820809857614,24.589462280273438],[59.95294746038232,24.537277221679688],[59.94331935475678,24.483718872070312],[59.94125582542067,24.432907104492188],[59.93644042418626,24.279098510742188],[59.92611935243404,24.210433959960938],[59.91166445623312,24.136276245117188],[59.891003681240576,24.088211059570312],[59.88066847319146,23.93096923828125],[59.86412545369721,23.84857177734375],[59.84757420214579,23.68927001953125],[59.825493056630116,23.58489990234375],[59.806160040206585,23.37066650390625],[59.78681580611529,23.14544677734375],[59.78405142812333,22.99713134765625],[59.78681580611529,22.83233642578125],[59.81168490365651,22.68951416015625],[59.819970482060974,22.54119873046875],[59.82273188377389,22.43133544921875],[59.82273188377389,22.28302001953125],[59.819970482060974,22.22259521484375],[59.83101471582272,22.155303955078125],[59.82963438683562,22.039947509765625],[59.843435102680886,21.971282958984375],[59.85860928465383,21.899871826171875],[59.86412545369721,21.820220947265625],[59.86826198022007,21.748809814453125],[59.87653348992475,21.688385009765625],[59.89720326334453,21.614227294921875],[59.91235292739125,21.564788818359375],[59.92474296688904,21.498870849609375],[59.94125582542067,21.443939208984375],[59.94813375712998,21.416473388671875],[59.95913548025017,21.342315673828125],[59.97013355162739,21.243438720703125],[59.98937139195849,21.166534423828125],[60.00447899694398,21.095123291015625],[60.01546201341471,21.031951904296875],[60.028499607928445,20.999679565429688],[60.042903598091634,20.959854125976562],[60.05661584530574,20.932388305664062],[60.062784498580335,20.893936157226562],[60.085393030279874,20.828018188476562],[60.10045677618282,20.797805786132812],[60.11346083460998,20.778579711914062],[60.12851175220178,20.745620727539062],[60.14629032974547,20.692062377929688],[60.153809143552216,20.660476684570312],[60.146973929322854,20.595932006835938],[60.13398310713261,20.532760620117188],[60.127143771314636,20.498428344726562],[60.11756631279752,20.469589233398438],[60.10387939460457,20.432510375976562],[60.094295166897965,20.416030883789062],[60.083338349596794,20.395431518554688],[60.05935761134086,20.355606079101562],[60.04221783621822,20.322647094726562],[60.03330163588306,20.300674438476562],[60.02301072129413,20.282821655273438],[60.003792437284226,20.260848999023438],[59.98662381344059,20.260848999023438],[59.971508053826554,20.258102416992188],[59.961197896769185,20.234756469726562],[59.9543226757682,20.183944702148438],[59.964634972356215,20.075454711914062],[59.974944059759125,20.027389526367188],[59.98112797206866,19.995803833007812],[59.992118742381244,19.955978393554688],[60.0127166012915,19.932632446289062],[60.04496079826938,19.931259155273438],[60.06518310790344,19.923362731933594],[60.08642032260055,19.926795959472656],[60.079571102406774,19.921302795410156],[60.07100757604961,19.909629821777344],[60.064497808747014,19.89795684814453],[60.05593036820596,19.89177703857422],[60.0480463582382,19.88903045654297],[60.0350164767239,19.87049102783203],[60.02781354695771,19.86156463623047],[60.023353803419496,19.854698181152344],[60.01614833082391,19.84508514404297],[59.997956104739856,19.82105255126953],[59.994179105518434,19.81212615966797],[59.985593412687976,19.797706604003906],[59.980784451685054,19.79015350341797],[59.97391329541318,19.777793884277344],[59.962916479136254,19.758567810058594],[59.957072935349565,19.744834899902344],[59.95225983128991,19.736595153808594],[59.94710215833544,19.72698211669922],[59.937128381460106,19.709815979003906],[59.9216458906463,19.684410095214844],[59.915106669245674,19.66449737548828],[59.906844758325505,19.648704528808594],[59.89685887246781,19.630165100097656],[59.885491970278125,19.61780548095703],[59.875155047865434,19.59857940673828],[59.86653849002597,19.57935333251953],[59.86136748351594,19.566307067871094],[59.85550603757327,19.55120086669922],[59.848264002017814,19.53540802001953],[59.84067541708709,19.517555236816406],[59.83481032557993,19.503822326660156],[59.8213512115253,19.476356506347656],[59.815482716136685,19.462623596191406],[59.81030377363804,19.448890686035156],[59.80167041438188,19.429664611816406],[59.79510756602241,19.415245056152344],[59.78647027139106,19.39739227294922],[59.77990443169585,19.379539489746094],[59.77402863787535,19.35962677001953],[59.764002837402,19.32598114013672],[59.75189872367115,19.278602600097656],[59.74255826734291,19.24633026123047],[59.737021950083054,19.222984313964844],[59.733561286147385,19.20307159423828],[59.731138608252785,19.187278747558594],[59.72629272584616,19.16187286376953],[59.71971504795703,19.13097381591797],[59.71417494750339,19.10076141357422],[59.70932660705978,19.08702850341797],[59.69858849620084,19.04102325439453],[59.69304489764441,19.020423889160156],[59.69096581157702,19.01012420654297],[59.68819349604794,19.00257110595703],[59.685074366793664,18.992271423339844],[59.68091507599631,18.97991180419922],[59.67606191742629,18.965492248535156],[59.671554783652915,18.95313262939453],[59.66670026941729,18.937339782714844],[59.6601108755862,18.92292022705078],[59.65039782939571,18.90026092529297],[59.637905493626604,18.86850357055664],[59.63443457494949,18.859920501708984],[59.63026899876238,18.849964141845703],[59.62454048752058,18.837947845458984],[59.61742188480661,18.822498321533203],[59.60943336371317,18.80258560180664],[59.6071753939183,18.793315887451172],[59.60265899915027,18.780956268310547],[59.59953190876407,18.77340316772461],[59.59623077551909,18.763103485107422],[59.58980132257225,18.746280670166016],[59.58649923383141,18.73769760131836],[59.583718276045964,18.72842788696289],[59.58232771092824,18.716754913330078],[59.58024175546603,18.707141876220703],[59.576417167837526,18.690319061279297],[59.57380924517459,18.672122955322266],[59.57102723820761,18.66250991821289],[59.56737550503034,18.654613494873047],[59.56302768700563,18.633670806884766],[59.56007084997047,18.623027801513672],[59.55746166045271,18.615474700927734],[59.55363448340889,18.601055145263672],[59.55032884409701,18.591785430908203],[59.54284646229985,18.57736587524414],[59.54023593810587,18.570499420166016],[59.53518835112819,18.556079864501953],[59.53135864286049,18.543376922607422],[59.52857312715946,18.538570404052734],[59.525090908838244,18.533763885498047],[59.52143419249099,18.526897430419922],[59.51899616127268,18.518314361572266],[59.51168100998948,18.497371673583984],[59.506803361027174,18.484325408935547],[59.50453849857453,18.478145599365234],[59.501925006835,18.471965789794922],[59.4958260722639,18.462696075439453],[59.49077183440001,18.45754623413086],[59.48763434062946,18.45479965209961],[59.485542516141805,18.452396392822266],[59.482753215246895,18.449649810791016],[59.48048673863045,18.44827651977539],[59.476650816319996,18.444843292236328],[59.471942498096396,18.44106674194336],[59.46897766479065,18.44003677368164],[59.46409384281006,18.437976837158203],[59.46060496641219,18.435916900634766],[59.457813605999675,18.435230255126953],[59.45205569717797,18.43179702758789],[59.44856557822058,18.428020477294922],[59.44664585925349,18.423900604248047],[59.44542416317491,18.419437408447266],[59.444551496101006,18.414630889892578],[59.443678806511834,18.409137725830078],[59.442806094407075,18.40536117553711],[59.44193335978628,18.400897979736328],[59.44123515587788,18.398151397705078],[59.440187822995206,18.395061492919922],[59.43844219613556,18.39162826538086],[59.43756934892908,18.39059829711914],[59.43599816721112,18.390941619873047],[59.43390314475794,18.393001556396484],[59.43163339072105,18.395061492919922],[59.429014254579876,18.397464752197266],[59.426569544636514,18.401927947998047],[59.4174876473711,18.411884307861328],[59.41609021615892,18.414287567138672],[59.413644572766756,18.42184066772461],[59.411373460037495,18.423213958740234],[59.40648131533187,18.429737091064453],[59.402462239303546,18.433856964111328],[59.39826791248344,18.440380096435547],[59.39215025515198,18.445873260498047],[59.3895280639485,18.44552993774414],[59.38620633055136,18.445873260498047],[59.380785961506966,18.445873260498047],[59.37816289120624,18.445873260498047],[59.376763837418004,18.445873260498047],[59.37344085336074,18.447246551513672],[59.369592780878754,18.447246551513672],[59.368718158073456,18.447246551513672],[59.36591921357174,18.44930648803711],[59.362420208233786,18.44552993774414],[59.358570885622875,18.437976837158203],[59.35804594416618,18.434200286865234],[59.35927079493576,18.424243927001953],[59.36014566128002,18.41909408569336],[59.3632949933935,18.406734466552734],[59.36626909426177,18.401241302490234],[59.36906800990132,18.393001556396484],[59.37099213046821,18.379955291748047],[59.37239142233717,18.362789154052734],[59.37466514852119,18.350772857666016],[59.3758893994925,18.335323333740234],[59.377988012638916,18.323307037353516],[59.37833776887183,18.31472396850586],[59.37886239645805,18.307857513427734],[59.37886239645805,18.302021026611328],[59.37903727051661,18.298587799072266],[59.37693872229773,18.287944793701172],[59.37536472591566,18.284168243408203],[59.371516871683134,18.277645111083984],[59.3655693292738,18.27077865600586],[59.36312003816558,18.263568878173828],[59.35927079493576,18.25704574584961],[59.357870961876394,18.255329132080078],[59.355071122551124,18.250179290771484],[59.35017084799535,18.239879608154297],[59.34737037352139,18.232669830322266],[59.3449197688761,18.226146697998047],[59.34159366540317,18.217220306396484],[59.340018029005634,18.214130401611328],[59.33809215192027,18.208637237548828],[59.337216717147356,18.203144073486328],[59.33686653692094,18.19387435913086],[59.33809215192027,18.183917999267578],[59.33861740195461,18.177051544189453],[59.33896756413194,18.167438507080078],[59.339667877657426,18.16091537475586],[59.341943796898505,18.151988983154297],[59.344569668061055,18.143062591552734],[59.34684525884261,18.136539459228516],[59.3482455466069,18.131389617919922],[59.349295724534485,18.125896453857422],[59.34982080131775,18.121089935302734],[59.35017084799535,18.109073638916016]]



